<!-- medication.wxml -->
<view class="container">
  <!-- 页面标题 -->
  <view class="page-title">用药记录</view>
  
  <!-- 内容区域 -->
  <view class="content-area">
    
    <!-- 无用药计划提示 -->
    <view wx:if="{{medicationPlans.length === 0}}" class="no-medications">
      <text class="no-medications-text">暂无用药计划</text>
    </view>
    
    <!-- 用药计划列表 -->
    <view wx:else class="medication-plans-list">
      <!-- 添加按钮 -->
      <view class="add-button-container">
        <button class="add-button" bindtap="showAddModal">+ 添加用药计划</button>
      </view>
      
      <!-- 用药计划卡片 -->
      <view wx:for="{{medicationPlans}}" wx:key="medicationPlansId" class="medication-plan-card">
        <!-- 计划头部 -->
        <view class="plan-header">
          <view class="plan-status" wx:if="{{item.isActive === '1'}}" style="color: #07c160;">启用中</view>
          <view class="plan-status" wx:else style="color: #ff4757;">已停用</view>
          <view class="plan-name">
            <text class="drug-name">{{item.drugName}}</text>
            <text class="nick-name">({{item.nickName}})</text>
          </view>
        </view>
        
        <!-- 计划详情 -->
        <view class="plan-details">
          <view class="detail-item">
            <text class="detail-label">剂量：</text>
            <text class="detail-value">{{item.dosage}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">服用频率：</text>
            <text class="detail-value">{{item.frequency}}</text>
          </view>
          <view class="detail-item" wx:if="{{item.remark}}">
            <text class="detail-label">备注：</text>
            <text class="detail-value">{{item.remark}}</text>
          </view>
        </view>
        
        <!-- 操作按钮 -->
        <view class="plan-actions">
          <button class="action-button edit-button" bindtap="showEditModal" data-planid="{{item.medicationPlansId}}">编辑</button>
          <button class="action-button delete-button" bindtap="deletePlan" data-planid="{{item.medicationPlansId}}">删除</button>
        </view>
        
        <!-- 用药记录 -->
          <view class="records-section">
            <view class="section-header" bindtap="togglePlanRecords" data-planid="{{item.medicationPlansId}}">
              <view class="section-title-wrapper">
                <view class="section-title">用药记录</view>
                <view class="expand-icon" wx:if="{{item.records && item.records.length > 0}}">
                  {{expandedPlans[item.medicationPlansId] ? '▼' : '▶'}}
                </view>
              </view>
              <button class="add-record-button" bindtap="showAddRecordModal" data-planid="{{item.medicationPlansId}}">+ 新增记录</button>
            </view>
            
            <!-- 展开状态下显示记录 -->
            <view wx:if="{{expandedPlans[item.medicationPlansId]}}">
              <!-- 无记录提示 -->
              <view wx:if="{{!item.records || item.records.length === 0}}" class="no-records">
                <text class="no-records-text">暂无用药记录</text>
              </view>
              
              <!-- 记录列表 -->
              <view wx:else class="records-list">
                <view wx:for="{{item.records}}" wx:for-item="record" wx:key="medicationRecordId" class="record-item">
                  <view class="record-time">{{record.time}}</view>
                  <view class="record-content">
                    <text class="record-remark">{{record.remark}}</text>
                    <view class="record-meta">
                      <text class="record-creator">{{record.createBy}}</text>
                      <text class="record-create-time">{{record.createTime}}</text>
                    </view>
                  </view>
                  <view class="record-actions">
                    <button class="action-btn edit-record-btn" bindtap="showEditRecordModal" data-planid="{{item.medicationPlansId}}" data-record="{{record}}">编辑</button>
                    <button class="action-btn delete-record-btn" bindtap="deleteRecord" data-recordid="{{record.medicationRecordId}}">删除</button>
                  </view>
                </view>
              </view>
            </view>
          </view>
      </view>
    </view>
    
    <!-- 弹窗 -->
    <view wx:if="{{showModal}}" class="modal-container">
      <view class="modal-overlay" bindtap="closeModal"></view>
      <view class="modal-content">
        <view class="modal-header">
          <text class="modal-title">{{isEditMode ? '编辑用药计划' : '添加用药计划'}}</text>
          <button class="close-button" bindtap="closeModal">×</button>
        </view>
        <view class="modal-body">
          <view class="form-group">
            <text class="form-label">药品名称</text>
            <input 
              class="form-input" 
              placeholder="请输入药品名称" 
              data-field="drugName"
              bindinput="onInputChange" 
              value="{{formData.drugName}}"
            />
          </view>
          <view class="form-group">
            <text class="form-label">药品别名</text>
            <input 
              class="form-input" 
              placeholder="请输入药品别名" 
              data-field="nickName"
              bindinput="onInputChange" 
              value="{{formData.nickName}}"
            />
          </view>
          <view class="form-group">
            <text class="form-label">剂量</text>
            <input 
              class="form-input" 
              placeholder="请输入剂量" 
              data-field="dosage"
              bindinput="onInputChange" 
              value="{{formData.dosage}}"
            />
          </view>
          <view class="form-group">
            <text class="form-label">服用频率</text>
            <input 
              class="form-input" 
              placeholder="请输入服用频率" 
              data-field="frequency"
              bindinput="onInputChange" 
              value="{{formData.frequency}}"
            />
          </view>
          <view class="form-group">
            <text class="form-label">备注</text>
            <textarea 
              class="form-textarea" 
              placeholder="请输入备注信息" 
              data-field="remark"
              bindinput="onInputChange" 
              value="{{formData.remark}}"
              auto-height
            ></textarea>
          </view>
          <view class="form-group">
            <text class="form-label">状态</text>
            <picker 
              class="form-picker" 
              range="['启用', '停用']" 
              data-field="isActive"
              bindchange="onStatusChange" 
              value="{{formData.isActive === '1' ? 0 : 1}}"
            >
              <view class="picker-content">
                <text>{{formData.isActive === '1' ? '启用' : '停用'}}</text>
                <text class="picker-arrow">▼</text>
              </view>
            </picker>
          </view>
        </view>
        <view class="modal-footer">
          <button class="footer-button cancel-button" bindtap="closeModal">取消</button>
          <button class="footer-button submit-button" bindtap="submitForm">{{isEditMode ? '更新' : '添加'}}</button>
        </view>
      </view>
    </view>
    
    <!-- 新增用药记录弹窗 -->
    <view wx:if="{{showRecordModal}}" class="modal-container">
      <view class="modal-overlay" bindtap="closeRecordModal"></view>
      <view class="modal-content">
        <view class="modal-header">
          <text class="modal-title">新增用药记录</text>
          <button class="close-button" bindtap="closeRecordModal">×</button>
        </view>
        <view class="modal-body">
          <!-- 服用时间 -->
          <view class="form-group">
            <text class="form-label">服用时间</text>
            
            <!-- 日期选择器 -->
            <view class="section custom-section date-picker-section">
              <picker mode="date" value="{{recordForm.date}}" start="2020-01-01" end="2030-12-31" bindchange="bindRecordDateChange" class="form-picker">
                <view class="picker-content">
                  <text class="picker-text">{{recordForm.date || '请选择日期'}}</text>
                  <text class="picker-arrow">▼</text>
                </view>
              </picker>
            </view>
            
            <!-- 时间选择器 -->
            <view class="section custom-section time-picker-section">
              <picker mode="time" value="{{recordForm.time}}" start="00:00" end="23:59" bindchange="bindRecordTimeChange" class="form-picker">
                <view class="picker-content">
                  <text class="picker-text">{{recordForm.time || '请选择时间'}}</text>
                  <text class="picker-arrow">▼</text>
                </view>
              </picker>
            </view>
          </view>
          <view class="form-group">
            <text class="form-label">备注</text>
            <textarea 
              class="form-textarea" 
              placeholder="请输入备注信息" 
              bindinput="onRecordRemarkChange" 
              value="{{recordForm.remark}}"
              auto-height
            ></textarea>
          </view>
        </view>
        <view class="modal-footer">
          <button class="footer-button cancel-button" bindtap="closeRecordModal">取消</button>
          <button class="footer-button submit-button" bindtap="submitRecord">提交</button>
        </view>
      </view>
    </view>
    
    <!-- 编辑用药记录弹窗 -->
    <view wx:if="{{showEditRecordModal}}" class="modal-container">
      <view class="modal-overlay" bindtap="closeEditRecordModal"></view>
      <view class="modal-content">
        <view class="modal-header">
          <text class="modal-title">编辑用药记录</text>
          <button class="close-button" bindtap="closeEditRecordModal">×</button>
        </view>
        <view class="modal-body">
          <!-- 服用时间 -->
          <view class="form-group">
            <text class="form-label">服用时间</text>
            
            <!-- 日期选择器 -->
            <view class="section custom-section date-picker-section">
              <picker mode="date" value="{{editRecordForm.date}}" start="2020-01-01" end="2030-12-31" bindchange="bindEditRecordDateChange" class="form-picker">
                <view class="picker-content">
                  <text class="picker-text">{{editRecordForm.date || '请选择日期'}}</text>
                  <text class="picker-arrow">▼</text>
                </view>
              </picker>
            </view>
            
            <!-- 时间选择器 -->
            <view class="section custom-section time-picker-section">
              <picker mode="time" value="{{editRecordForm.time}}" start="00:00" end="23:59" bindchange="bindEditRecordTimeChange" class="form-picker">
                <view class="picker-content">
                  <text class="picker-text">{{editRecordForm.time || '请选择时间'}}</text>
                  <text class="picker-arrow">▼</text>
                </view>
              </picker>
            </view>
          </view>
          <view class="form-group">
            <text class="form-label">备注</text>
            <textarea 
              class="form-textarea" 
              placeholder="请输入备注信息" 
              bindinput="onEditRecordRemarkChange" 
              value="{{editRecordForm.remark}}"
              auto-height
            ></textarea>
          </view>
        </view>
        <view class="modal-footer">
          <button class="footer-button cancel-button" bindtap="closeEditRecordModal">取消</button>
          <button class="footer-button submit-button" bindtap="submitEditRecord">更新</button>
        </view>
      </view>
    </view>
    
    <!-- 加载更多提示 -->
    <view wx:if="{{loading}}" class="loading-more">
      <text class="loading-text">加载中...</text>
    </view>
    
    <!-- 没有更多数据提示 -->
    <view wx:elif="{{!hasMore && medicationPlans.length > 0}}" class="no-more">
      <text class="no-more-text">没有更多数据了</text>
    </view>
  </view>
  
  <!-- 底部返回按钮 -->
  <view class="back-button-container">
    <button class="back-button" bindtap="navigateBack">返回首页</button>
  </view>
</view>
